{% extends "base.html" %}

{% block title %}Lead Details - {{ lead.name }} | Admin Dashboard{% endblock %}

{% block content %}
<style>
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
    transform: translateX(-50%);
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
    display: flex;
    align-items: flex-start;
}

.timeline-item-left {
    justify-content: flex-start;
    padding-right: 50%;
}

.timeline-item-right {
    justify-content: flex-end;
    padding-left: 50%;
}

.timeline-point {
    position: absolute;
    left: 50%;
    top: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transform: translateX(-50%);
    z-index: 2;
}

.timeline-content {
    width: 90%;
    max-width: 500px;
}

@media (max-width: 768px) {
    .timeline::before {
        left: 20px;
    }
    
    .timeline-item {
        padding-left: 50px !important;
        padding-right: 0 !important;
        justify-content: flex-start !important;
    }
    
    .timeline-point {
        left: 20px;
    }
    
    .timeline-content {
        width: 100%;
    }
}
</style>
<div class="container-fluid py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h4 mb-1">Lead Details</h1>
            <p class="text-muted mb-0">Comprehensive view for <strong>{{ lead.name }}</strong> (ID: {{ lead.id }})</p>
        </div>
        <div class="text-end">
            <a href="{{ url_for('admin.leads_management') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Leads
            </a>
        </div>
    </div>

    <!-- Lead Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card bg-gradient-primary text-white">
                <div class="stat-number">{{ lead.status|title }}</div>
                <div class="stat-label">Lead Status</div>
                <div class="mt-2"><small><i class="fas fa-info-circle me-1"></i>Current stage</small></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card border border-success">
                <div class="stat-number text-success">{{ feedbacks|length }}</div>
                <div class="stat-label">Feedbacks</div>
                <div class="mt-2"><small class="text-muted"><i class="fas fa-comments me-1"></i>Total feedback records</small></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card border border-warning">
                <div class="stat-number text-warning">{{ call_logs|length }}</div>
                <div class="stat-label">Call Logs</div>
                <div class="mt-2"><small class="text-muted"><i class="fas fa-phone me-1"></i>Total calls made</small></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card border border-info">
                <div class="stat-number text-info">{{ reassignments|length }}</div>
                <div class="stat-label">Reassignments</div>
                <div class="mt-2"><small class="text-muted"><i class="fas fa-exchange-alt me-1"></i>Times reassigned</small></div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0 py-3">
            <ul class="nav nav-tabs card-header-tabs" id="leadDetailsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basic-info" type="button" role="tab" aria-controls="basic-info" aria-selected="true">
                        <i class="fas fa-user me-2"></i>Basic Information
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="assignment-tab" data-bs-toggle="tab" data-bs-target="#assignment" type="button" role="tab" aria-controls="assignment" aria-selected="false">
                        <i class="fas fa-user-clock me-2"></i>Assignment History
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback" type="button" role="tab" aria-controls="feedback" aria-selected="false">
                        <i class="fas fa-comments me-2"></i>Feedback History ({{ feedbacks|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reassignment-tab" data-bs-toggle="tab" data-bs-target="#reassignment" type="button" role="tab" aria-controls="reassignment" aria-selected="false">
                        <i class="fas fa-exchange-alt me-2"></i>Reassignment History
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="leadDetailsTabsContent">
                
                <!-- Basic Information Tab -->
                <div class="tab-pane fade show active" id="basic-info" role="tabpanel" aria-labelledby="basic-info-tab">
                    <table class="table table-bordered align-middle">
                        <tr>
                            <th>ID</th>
                            <td>{{ lead.id }}</td>
                            <th>Name</th>
                            <td>{{ lead.name }}</td>
                        </tr>
                        <tr>
                            <th>Mobile</th>
                            <td>{{ lead.mobile }}</td>
                            <th>Email</th>
                            <td>{{ lead.email or 'N/A' }}</td>
                        </tr>
                        <tr>
                            <th>Project</th>
                            <td>{{ lead.project_name }}</td>
                            <th>Location</th>
                            <td>{{ lead.location }}</td>
                        </tr>
                        <tr>
                            <th>Pincode</th>
                            <td>{{ lead.pincode or 'N/A' }}</td>
                            <th>Status</th>
                            <td><span class="badge bg-primary">{{ lead.status|title }}</span></td>
                        </tr>
                        <tr>
                            <th>Assigned Agent</th>
                            <td colspan="3">
                                {{ lead.assigned_agent.username if lead.assigned_agent else 'Not Assigned' }}
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Assignment History Tab -->
                <div class="tab-pane fade" id="assignment" role="tabpanel" aria-labelledby="assignment-tab">
                    {% if assignment_history %}
                    <div class="table-responsive">
                        <table class="table table-striped align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Agent</th>
                                    <th>Assigned By</th>
                                    <th>Date</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for history in assignment_history %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ history.agent.username }}</td>
                                    <td>{{ history.assigned_by.username if history.assigned_by else 'N/A' }}</td>
                                    <td>{{ history.assigned_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ history.note or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No assignment history found for this lead.</p>
                    {% endif %}
                </div>
                
                <!-- Feedback History Tab -->
                <div class="tab-pane fade" id="feedback" role="tabpanel" aria-labelledby="feedback-tab">
                    <!-- Lead Summary -->
                    {% include 'agent/feedback_history.html' %}
                   
                </div>
                
                <!-- Reassignment History Tab -->
                <div class="tab-pane fade" id="reassignment" role="tabpanel" aria-labelledby="reassignment-tab">
                    {% if reassignments %}
                    <div class="table-responsive">
                        <table class="table table-striped align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>From Agent</th>
                                    <th>To Agent</th>
                                    <th>Reassigned At</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in reassignments %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ r.from_agent.username if r.from_agent else 'N/A' }}</td>
                                    <td>{{ r.to_agent.username if r.to_agent else 'N/A' }}</td>
                                    <td>{{ r.reassigned_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ r.reason or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No reassignment history for this lead.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}

{% endblock %}

{% block scripts %}
<script>
// Initialize Bootstrap popovers
var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
popoverTriggerList.map(function (popoverTriggerEl) {
    return new bootstrap.Popover(popoverTriggerEl);
});
</script>
{% endblock %}