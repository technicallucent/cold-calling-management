{% extends "base.html" %}

{% block title %}Lead Details - {{ lead.name }} | Admin Dashboard{% endblock %}

{% block content %}
<style>
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
    transform: translateX(-50%);
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
    display: flex;
    align-items: flex-start;
}

.timeline-item-left {
    justify-content: flex-start;
    padding-right: 50%;
}

.timeline-item-right {
    justify-content: flex-end;
    padding-left: 50%;
}

.timeline-point {
    position: absolute;
    left: 50%;
    top: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transform: translateX(-50%);
    z-index: 2;
}

.timeline-content {
    width: 90%;
    max-width: 500px;
}

@media (max-width: 768px) {
    .timeline::before {
        left: 20px;
    }
    
    .timeline-item {
        padding-left: 50px !important;
        padding-right: 0 !important;
        justify-content: flex-start !important;
    }
    
    .timeline-point {
        left: 20px;
    }
    
    .timeline-content {
        width: 100%;
    }
}
</style>
<div class="container-fluid py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h4 mb-1">Lead Details</h1>
            <p class="text-muted mb-0">Comprehensive view for <strong>{{ lead.name }}</strong> (ID: {{ lead.id }})</p>
        </div>
        <div class="text-end">
            <a href="{{ url_for('admin.leads_management') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Leads
            </a>
        </div>
    </div>

    <!-- Lead Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card bg-gradient-primary text-white">
                <div class="stat-number">{{ lead.status|title }}</div>
                <div class="stat-label">Lead Status</div>
                <div class="mt-2"><small><i class="fas fa-info-circle me-1"></i>Current stage</small></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card border border-success">
                <div class="stat-number text-success">{{ feedbacks|length }}</div>
                <div class="stat-label">Feedbacks</div>
                <div class="mt-2"><small class="text-muted"><i class="fas fa-comments me-1"></i>Total feedback records</small></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card border border-warning">
                <div class="stat-number text-warning">{{ call_logs|length }}</div>
                <div class="stat-label">Call Logs</div>
                <div class="mt-2"><small class="text-muted"><i class="fas fa-phone me-1"></i>Total calls made</small></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card border border-info">
                <div class="stat-number text-info">{{ reassignments|length }}</div>
                <div class="stat-label">Reassignments</div>
                <div class="mt-2"><small class="text-muted"><i class="fas fa-exchange-alt me-1"></i>Times reassigned</small></div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0 py-3">
            <ul class="nav nav-tabs card-header-tabs" id="leadDetailsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basic-info" type="button" role="tab" aria-controls="basic-info" aria-selected="true">
                        <i class="fas fa-user me-2"></i>Basic Information
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="assignment-tab" data-bs-toggle="tab" data-bs-target="#assignment" type="button" role="tab" aria-controls="assignment" aria-selected="false">
                        <i class="fas fa-user-clock me-2"></i>Assignment History
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback" type="button" role="tab" aria-controls="feedback" aria-selected="false">
                        <i class="fas fa-comments me-2"></i>Feedback History ({{ feedbacks|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reassignment-tab" data-bs-toggle="tab" data-bs-target="#reassignment" type="button" role="tab" aria-controls="reassignment" aria-selected="false">
                        <i class="fas fa-exchange-alt me-2"></i>Reassignment History
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="leadDetailsTabsContent">
                
                <!-- Basic Information Tab -->
                <div class="tab-pane fade show active" id="basic-info" role="tabpanel" aria-labelledby="basic-info-tab">
                    <table class="table table-bordered align-middle">
                        <tr>
                            <th>ID</th>
                            <td>{{ lead.id }}</td>
                            <th>Name</th>
                            <td>{{ lead.name }}</td>
                        </tr>
                        <tr>
                            <th>Mobile</th>
                            <td>{{ lead.mobile }}</td>
                            <th>Email</th>
                            <td>{{ lead.email or 'N/A' }}</td>
                        </tr>
                        <tr>
                            <th>Project</th>
                            <td>{{ lead.project_name }}</td>
                            <th>Location</th>
                            <td>{{ lead.location }}</td>
                        </tr>
                        <tr>
                            <th>Pincode</th>
                            <td>{{ lead.pincode or 'N/A' }}</td>
                            <th>Status</th>
                            <td><span class="badge bg-primary">{{ lead.status|title }}</span></td>
                        </tr>
                        <tr>
                            <th>Assigned Agent</th>
                            <td colspan="3">
                                {{ lead.assigned_agent.username if lead.assigned_agent else 'Not Assigned' }}
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Assignment History Tab -->
                <div class="tab-pane fade" id="assignment" role="tabpanel" aria-labelledby="assignment-tab">
                    {% if assignment_history %}
                    <div class="table-responsive">
                        <table class="table table-striped align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Agent</th>
                                    <th>Assigned By</th>
                                    <th>Date</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for history in assignment_history %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ history.agent.username }}</td>
                                    <td>{{ history.assigned_by.username if history.assigned_by else 'N/A' }}</td>
                                    <td>{{ history.assigned_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ history.note or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No assignment history found for this lead.</p>
                    {% endif %}
                </div>
                
                <!-- Feedback History Tab -->
                <div class="tab-pane fade" id="feedback" role="tabpanel" aria-labelledby="feedback-tab">
                    <!-- Lead Summary -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="card-title">{{ lead.name }}</h5>
                                    <div class="row mt-3">
                                        <div class="col-sm-6">
                                            <p class="mb-1"><strong><i class="fas fa-mobile-alt me-2 text-muted"></i>Mobile:</strong> {{ lead.mobile }}</p>
                                            {% if lead.email %}
                                            <p class="mb-1"><strong><i class="fas fa-envelope me-2 text-muted"></i>Email:</strong> {{ lead.email }}</p>
                                            {% endif %}
                                            <p class="mb-1"><strong><i class="fas fa-building me-2 text-muted"></i>Project:</strong> {{ lead.project_name }}</p>
                                        </div>
                                        <div class="col-sm-6">
                                            <p class="mb-1"><strong><i class="fas fa-map-marker-alt me-2 text-muted"></i>Location:</strong> {{ lead.location }}</p>
                                            <p class="mb-1"><strong><i class="fas fa-calendar me-2 text-muted"></i>Assigned:</strong> 
                                                {{ lead.assigned_date.strftime('%Y-%m-%d') if lead.assigned_date else 'N/A' }}
                                            </p>
                                            <p class="mb-1"><strong><i class="fas fa-tag me-2 text-muted"></i>Status:</strong> 
                                                <span class="badge 
                                                    {% if lead.status == 'completed' %}bg-success
                                                    {% elif lead.status == 'interested' %}bg-success
                                                    {% elif lead.status == 'not_interested' %}bg-danger
                                                    {% elif lead.status == 'callback' %}bg-warning
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ lead.status|replace('_', ' ')|title }}
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-md-end">
                                    <div class="h4 text-primary mb-2">{{ feedbacks|length }}</div>
                                    <small class="text-muted">Total Feedback Entries</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feedback Timeline -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 py-3">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-comments text-primary me-2"></i>Interaction Timeline
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if feedbacks %}
                            <div class="timeline">
                                {% for feedback in feedbacks %}
                                <div class="timeline-item {{ loop.cycle('timeline-item-left', 'timeline-item-right') }}">
                                    <div class="timeline-point 
                                        {% if feedback.feedback_type.value == 'interested' %}bg-success
                                        {% elif feedback.feedback_type.value == 'not_interested' %}bg-danger
                                        {% elif feedback.feedback_type.value == 'callback' %}bg-warning
                                        {% else %}bg-primary{% endif %}">
                                        <i class="fas 
                                            {% if feedback.feedback_type.value == 'interested' %}fa-thumbs-up
                                            {% elif feedback.feedback_type.value == 'not_interested' %}fa-thumbs-down
                                            {% elif feedback.feedback_type.value == 'callback' %}fa-clock
                                            {% else %}fa-comment{% endif %} text-white">
                                        </i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0 text-capitalize">
                                                        {{ feedback.feedback_type.value|replace('_', ' ') }}
                                                    </h6>
                                                    <small class="text-muted">{{ feedback.created_at.strftime('%b %d, %Y %I:%M %p') }}</small>
                                                </div>
                                                
                                                <!-- Feedback Content Based on Type -->
                                                {% if feedback.feedback_type.value == 'interested' %}
                                                <div class="row mt-3">
                                                    {% if feedback.project_interested %}
                                                    <div class="col-sm-6 mb-2">
                                                        <strong>Project Interested:</strong> {{ feedback.project_interested }}
                                                    </div>
                                                    {% endif %}
                                                    {% if feedback.location_preferred %}
                                                    <div class="col-sm-6 mb-2">
                                                        <strong>Location Preferred:</strong> {{ feedback.location_preferred }}
                                                    </div>
                                                    {% endif %}
                                                    {% if feedback.configuration_interested %}
                                                    <div class="col-sm-6 mb-2">
                                                        <strong>Configuration:</strong> {{ feedback.configuration_interested }}
                                                    </div>
                                                    {% endif %}
                                                    {% if feedback.budget_comfortable %}
                                                    <div class="col-sm-6 mb-2">
                                                        <strong>Budget:</strong> {{ feedback.budget_comfortable }}
                                                    </div>
                                                    {% endif %}
                                                    {% if feedback.interest_level %}
                                                    <div class="col-sm-6 mb-2">
                                                        <strong>Interest Level:</strong> 
                                                        <span class="badge 
                                                            {% if feedback.interest_level.value == 'high' %}bg-success
                                                            {% elif feedback.interest_level.value == 'medium' %}bg-warning
                                                            {% else %}bg-secondary{% endif %}">
                                                            {{ feedback.interest_level.value|title }}
                                                        </span>
                                                    </div>
                                                    {% endif %}
                                                    {% if feedback.possession_timeline %}
                                                    <div class="col-sm-6 mb-2">
                                                        <strong>Timeline:</strong> {{ feedback.possession_timeline }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                {% elif feedback.feedback_type.value == 'not_interested' %}
                                                <div class="mt-3">
                                                    {% if feedback.not_interested_reason %}
                                                    <p><strong>Reason:</strong> {{ feedback.not_interested_reason|replace('_', ' ')|title }}</p>
                                                    {% endif %}
                                                </div>
                                                {% elif feedback.feedback_type.value == 'callback' %}
                                                <div class="row mt-3">
                                                    {% if feedback.callback_time %}
                                                    <div class="col-sm-6 mb-2">
                                                        <strong>Callback Time:</strong> {{ feedback.callback_time.strftime('%b %d, %Y %I:%M %p') }}
                                                    </div>
                                                    {% endif %}
                                                    {% if feedback.callback_priority %}
                                                    <div class="col-sm-6 mb-2">
                                                        <strong>Priority:</strong> 
                                                        <span class="badge 
                                                            {% if feedback.callback_priority == 'high' %}bg-danger
                                                            {% elif feedback.callback_priority == 'medium' %}bg-warning
                                                            {% else %}bg-info{% endif %}">
                                                            {{ feedback.callback_priority|title }}
                                                        </span>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                {% endif %}

                                                <!-- Additional Notes -->
                                                {% if feedback.additional_notes %}
                                                <div class="mt-3">
                                                    <strong>Additional Notes:</strong>
                                                    <p class="mb-0 mt-1 text-muted">{{ feedback.additional_notes }}</p>
                                                </div>
                                                {% endif %}

                                                <!-- Callback Notes -->
                                                {% if feedback.callback_notes %}
                                                <div class="mt-3">
                                                    <strong>Callback Notes:</strong>
                                                    <p class="mb-0 mt-1 text-muted">{{ feedback.callback_notes }}</p>
                                                </div>
                                                {% endif %}

                                                <!-- Recording -->
                                                {% if feedback.recording_path %}
                                                <div class="mt-3">
                                                    <strong>Recording:</strong>
                                                    <div class="mt-1">
                                                        <audio controls class="w-100">
                                                            <source src="{{ url_for('static', filename=feedback.recording_path) }}" type="audio/mpeg">
                                                            Your browser does not support the audio element.
                                                        </audio>
                                                    </div>
                                                </div>
                                                {% endif %}

                                                <!-- Call Duration -->
                                                {% if feedback.call_duration %}
                                                <div class="mt-3">
                                                    <small class="text-muted">
                                                        <i class="fas fa-clock me-1"></i>
                                                        Call Duration: {{ (feedback.call_duration // 60) }}:{{ "%02d" % (feedback.call_duration % 60) }}
                                                    </small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Feedback Yet</h5>
                                <p class="text-muted">No feedback has been recorded for this lead yet.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Reassignment History Tab -->
                <div class="tab-pane fade" id="reassignment" role="tabpanel" aria-labelledby="reassignment-tab">
                    {% if reassignments %}
                    <div class="table-responsive">
                        <table class="table table-striped align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>From Agent</th>
                                    <th>To Agent</th>
                                    <th>Reassigned At</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in reassignments %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ r.from_agent.username if r.from_agent else 'N/A' }}</td>
                                    <td>{{ r.to_agent.username if r.to_agent else 'N/A' }}</td>
                                    <td>{{ r.reassigned_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ r.reason or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No reassignment history for this lead.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}

{% endblock %}

{% block scripts %}
<script>
// Initialize Bootstrap popovers
var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
popoverTriggerList.map(function (popoverTriggerEl) {
    return new bootstrap.Popover(popoverTriggerEl);
});
</script>
{% endblock %}